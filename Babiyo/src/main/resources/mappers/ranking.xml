<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mealmaker.babiyo.ranking">

<select id="toDayList" resultType="productDto">
SELECT NO, NVL(R.NAME, '-') NAME
FROM(SELECT NO, NAME, ROWNUM RANKING
FROM(SELECT P.NO ,P.NAME , COUNT(*) COUNT
	FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
	ON D.ORDER_NO = O.NO
	JOIN PRODUCT P
	ON D.PRODUCT_NO = P.NO
	WHERE O.ORDER_DATE > SYSDATE - 1
	AND O.STATE_CODE = 2
	GROUP BY D.PRODUCT_NO, P.NAME, P.NO
	HAVING COUNT(*) > 0
	ORDER BY COUNT DESC)) R RIGHT OUTER JOIN
	(SELECT LEVEL,
	CASE WHEN LEVEL=1 THEN 1
	WHEN LEVEL=2 THEN 2
	WHEN LEVEL=3 THEN 3
	WHEN LEVEL=4 THEN 4
	WHEN LEVEL=5 THEN 5 END RANKING
	FROM DUAL
	CONNECT BY<![CDATA[LEVEL <= 5]]>) S
ON R.RANKING = S.RANKING
ORDER BY R.RANKING
</select>

<select id="weeklyList" resultType="productDto">
SELECT NO, NVL(R.NAME, '-') NAME
FROM(SELECT NO, NAME, ROWNUM RANKING
FROM(SELECT P.NO, P.NAME , COUNT(*) COUNT
	FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
	ON D.ORDER_NO = O.NO
	JOIN PRODUCT P
	ON D.PRODUCT_NO = P.NO
	WHERE O.ORDER_DATE > SYSDATE - 7
	AND O.STATE_CODE = 2
	GROUP BY D.PRODUCT_NO, P.NAME, P.NO
	HAVING COUNT(*) > 0
	ORDER BY COUNT DESC))R 
	RIGHT OUTER JOIN
	(SELECT LEVEL,
	CASE WHEN LEVEL=1 THEN 1
	WHEN LEVEL=2 THEN 2
	WHEN LEVEL=3 THEN 3
	WHEN LEVEL=4 THEN 4
	WHEN LEVEL=5 THEN 5 END RANKING
	FROM DUAL
	CONNECT BY<![CDATA[LEVEL <= 5]]>) S
ON R.RANKING = S.RANKING
ORDER BY R.RANKING
</select>

<select id="manList" resultType="productDto">
SELECT NO, NVL(R.NAME, '-') NAME
FROM(SELECT NO, NAME, ROWNUM RANKING
FROM(SELECT P.NO, P.NAME , COUNT(*) COUNT
	FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
	ON D.ORDER_NO = O.NO
	JOIN PRODUCT P
	ON D.PRODUCT_NO = P.NO
	JOIN MEMBER M
	ON O.MEMBER_ID = M.ID
	WHERE M.GENDER = '남'
	AND O.STATE_CODE = 2
	GROUP BY D.PRODUCT_NO, P.NAME, P.NO
	HAVING COUNT(*) > 0
	ORDER BY COUNT DESC)) R RIGHT OUTER JOIN
	(SELECT LEVEL,
	CASE WHEN LEVEL=1 THEN 1
	WHEN LEVEL=2 THEN 2
	WHEN LEVEL=3 THEN 3
	WHEN LEVEL=4 THEN 4
	WHEN LEVEL=5 THEN 5 END RANKING
	FROM DUAL
	CONNECT BY<![CDATA[LEVEL <= 5]]>) S
ON R.RANKING = S.RANKING
ORDER BY R.RANKING
</select>

<select id="womanList" resultType="productDto">
SELECT NO, NVL(R.NAME, '-') NAME
FROM(SELECT NO, NAME, ROWNUM RANKING
FROM(SELECT P.NO, P.NAME , COUNT(*) COUNT
	FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
	ON D.ORDER_NO = O.NO
	JOIN PRODUCT P
	ON D.PRODUCT_NO = P.NO
	JOIN MEMBER M
	ON O.MEMBER_ID = M.ID
	WHERE M.GENDER = '여'
	AND O.STATE_CODE = 2
	GROUP BY D.PRODUCT_NO, P.NAME, P.NO
	HAVING COUNT(*) > 0
	ORDER BY COUNT DESC)) R RIGHT OUTER JOIN
	(SELECT LEVEL,
	CASE WHEN LEVEL=1 THEN 1
	WHEN LEVEL=2 THEN 2
	WHEN LEVEL=3 THEN 3
	WHEN LEVEL=4 THEN 4
	WHEN LEVEL=5 THEN 5 END RANKING
	FROM DUAL
	CONNECT BY<![CDATA[LEVEL <= 5]]>) S
ON R.RANKING = S.RANKING
ORDER BY R.RANKING
</select>


</mapper>