<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mealmaker.babiyo.order">

<resultMap type="orderDto" id="orderResultMap">
<id column="NO" property="no"/>
<result column="MEMBER_ID" property="memberId"/>
<result column="ORDER_DATE" property="orderDate" javaType="java.util.Date"/>
<result column="TOTAL_PRICE" property="totalPrice"/>
<result column="RECEIVER_NAME" property="receiverName"/>
<result column="RECEIVER_PHONE" property="receiverPhone"/>
<result column="POST" property="post"/>
<result column="ADDRESS" property="address"/>
<result column="ADDRESS_DETAIL" property="addressDetail"/>
<result column="REQUEST" property="request"/>
<result column="STATE_CODE" property="stateCode"/>
</resultMap>

<resultMap type="productDto" id="productResultMap">
<id column="NO" property="no"/>
<result column="CATEGORY_CODE" property="categoryCode"/>
<result column="NAME" property="name"/>
<result column="PRICE" property="price"/>
<result column="STOCK" property="stock"/>
<result column="CONTENT" property="content"/>
</resultMap>


<select id="lastOrder" resultMap="orderResultMap" parameterType="String">
SELECT *
FROM (SELECT *
		FROM MEMBER_ORDER
		WHERE MEMBER_ID = #{memberId}
		ORDER BY ORDER_DATE DESC) 
WHERE <![CDATA[ ROWNUM <= 1 ]]>
</select>


<insert id="order" parameterType="orderDto"
useGeneratedKeys="true" keyProperty="no">
<selectKey keyProperty="no" resultType="int" order="AFTER">
	SELECT SEQ_MEMBER_ORDER_NO.CURRVAL 
	FROM DUAL
</selectKey>
INSERT INTO MEMBER_ORDER
(MEMBER_ID,ORDER_DATE,TOTAL_PRICE,RECEIVER_NAME,RECEIVER_PHONE
	,POST,ADDRESS,ADDRESS_DETAIL,REQUEST,STATE_CODE)
VALUES(#{memberId}, SYSDATE, #{totalPrice}, #{receiverName}, #{receiverPhone}
	, #{post}, #{address}, #{addressDetail}, #{request}, 1)
</insert>

<insert id="orderDetail" parameterType="orderDetailDto">
INSERT INTO ORDER_DETAIL(ORDER_NO, PRODUCT_NO, AMOUNT, PRICE)
VALUES(#{orderNo}, #{productNo}, #{amount}, #{price})
</insert>


</mapper>