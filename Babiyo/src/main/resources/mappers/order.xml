<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mealmaker.babiyo.order">

<resultMap type="orderDto" id="orderResultMap">
<id column="NO" property="no"/>
<result column="MEMBER_ID" property="memberId"/>
<result column="ORDER_DATE" property="orderDate" javaType="java.util.Date"/>
<result column="TOTAL_AMOUNT" property="totalAmount"/>
<result column="PREVIEW" property="preview"/>
<result column="PRODUCT_QUANTITY" property="productQuantity"/>
<result column="RECEIVER_NAME" property="receiverName"/>
<result column="RECEIVER_PHONE" property="receiverPhone"/>
<result column="POST" property="post"/>
<result column="ADDRESS" property="address"/>
<result column="ADDRESS_DETAIL" property="addressDetail"/>
<result column="REQUEST" property="request"/>
<result column="STATE_CODE" property="stateCode"/>
<result column="STATE_NAME" property="stateName"/>
</resultMap>

<select id="lastOrder" resultMap="orderResultMap" parameterType="String">
SELECT *
FROM (SELECT *
		FROM MEMBER_ORDER
		WHERE MEMBER_ID = #{memberId}
		ORDER BY ORDER_DATE DESC) 
WHERE <![CDATA[ ROWNUM <= 1 ]]>
</select>


<insert id="order" parameterType="orderDto"
useGeneratedKeys="true" keyProperty="no">
<selectKey keyProperty="no" resultType="int" order="AFTER">
	SELECT SEQ_MEMBER_ORDER_NO.CURRVAL 
	FROM DUAL
</selectKey>
INSERT INTO MEMBER_ORDER
(MEMBER_ID,ORDER_DATE,TOTAL_AMOUNT,PREVIEW,PRODUCT_QUANTITY,RECEIVER_NAME,RECEIVER_PHONE
	,POST,ADDRESS,ADDRESS_DETAIL,REQUEST,STATE_CODE)
VALUES(#{memberId}, SYSDATE, #{totalAmount}, #{preview}, #{productQuantity}, #{receiverName}
	, #{receiverPhone}, #{post}, #{address}, #{addressDetail}, #{request}, 1)
</insert>

<insert id="orderDetail" parameterType="orderDetailDto">
INSERT INTO ORDER_DETAIL(ORDER_NO, PRODUCT_NO, QUANTITY, PRICE)
VALUES(#{orderNo}, #{productNo}, #{quantity}, #{price})
</insert>

<select id="orderList" parameterType="map" resultMap="orderResultMap">
SELECT *
FROM(SELECT ROWNUM INROW, ORDER_DATE, NO, TOTAL_AMOUNT, PREVIEW, PRODUCT_QUANTITY, STATE_NAME
FROM(SELECT O.ORDER_DATE, O.NO, O.TOTAL_AMOUNT, O.PREVIEW, O.PRODUCT_QUANTITY, S.NAME STATE_NAME
	FROM MEMBER_ORDER O JOIN ORDER_STATE S
	ON O.STATE_CODE = S.CODE
	WHERE O.MEMBER_ID = #{id}
	ORDER BY O.ORDER_DATE DESC))
WHERE INROW BETWEEN ${begin} AND ${end}
</select>	

<select id="memberOrderCount" parameterType="String" resultType="int">
SELECT COUNT(*)
FROM MEMBER_ORDER
WHERE MEMBER_ID = #{value}
</select>

</mapper>